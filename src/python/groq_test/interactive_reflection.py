import requests
import json
import os

# Groq APIå¯†é‘°
api_key = "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"

# APIç«¯é»
url = "https://api.groq.com/openai/v1/chat/completions"

# è¨­ç½®è«‹æ±‚é ­
headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json"
}

# æ¨¡æ“¬çš„å°è©±ç‰‡æ®µ
sample_conversation = """
è­·å£«: æ‚¨å¥½ï¼Œæˆ‘æ˜¯è­·ç†å¸«å°æ—ï¼Œè«‹å•æ‚¨æ˜¯å¼µå°å¨çš„åª½åª½å—ï¼Ÿ
åª½åª½: æ˜¯çš„ï¼Œæˆ‘æ˜¯ä»–åª½åª½ã€‚
è­·å£«: å°å¨ç¾åœ¨æœ‰ä»€éº¼ä¸èˆ’æœçš„ç—‡ç‹€å‘¢ï¼Ÿ
åª½åª½: ä»–å¾æ˜¨å¤©é–‹å§‹ä¸€ç›´æ‹‰è‚šå­ï¼Œä»Šå¤©åˆé–‹å§‹ç™¼ç‡’äº†ã€‚
è­·å£«: å¤§ç´„æ‹‰äº†å¹¾æ¬¡å‘¢ï¼Ÿå¤§ä¾¿æ€§ç‹€å¦‚ä½•ï¼Ÿ
åª½åª½: æ˜¨å¤©æ‹‰äº†äº”å…­æ¬¡ï¼Œå¤§ä¾¿å¾ˆç¨€ï¼Œä»Šå¤©å·²ç¶“æ‹‰äº†ä¸‰æ¬¡äº†ã€‚
è­·å£«: ç™¼ç‡’å¤§ç´„æ˜¯å¹¾åº¦ï¼Ÿæœ‰æ²’æœ‰æ¸¬é‡éé«”æº«ï¼Ÿ
åª½åª½: æ—©ä¸Šé‡äº†ä¸€æ¬¡æ˜¯38.5åº¦ï¼Œå‰›æ‰åˆé‡æ˜¯39åº¦äº†ã€‚
è­·å£«: å°å¨æœ‰æ²’æœ‰å˜”åçš„æƒ…æ³ï¼Ÿ
åª½åª½: æ—©ä¸Šåäº†ä¸€æ¬¡ï¼Œä¸­åˆåˆåäº†ä¸€æ¬¡ã€‚
è­·å£«: å°å¨çš„é£Ÿæ…¾å’Œå–æ°´æƒ…æ³å¦‚ä½•ï¼Ÿ
åª½åª½: ä»–ä¸å¤ªæƒ³åƒæ±è¥¿ï¼Œå–æ°´ä¹Ÿå–å¾—å¾ˆå°‘ã€‚
"""

# æ¨¡æ“¬çš„å°è©±åˆ†æçµæœ
conversation_analysis = {
    "missing_questions": [
        "æœªè©¢å•ç—…äººéå»æ˜¯å¦æœ‰è…¹ç—›ç—…å²",
        "æœªç¢ºèªç—…ç«¥ç›®å‰æ˜¯å¦æœ‰è…¹ç—›ç—‡ç‹€",
        "æœªè©¢å•å°¿é‡æƒ…æ³",
        "æœªè©¢å•æ˜¯å¦å·²æœç”¨è—¥ç‰©"
    ],
    "response_delays": [
        {"after_statement": "è‚šå­ç—›å…©å¤©", "delay_seconds": 5},
        {"after_statement": "æ—©ä¸Šåäº†ä¸€æ¬¡", "delay_seconds": 3}
    ],
    "missed_keywords": ["è„«æ°´", "å°¿é‡", "è—¥ç‰©å²", "éæ•å²"],
    "overall_score": 75
}

# Gibbså…­éšæ®µæ¨¡å‹çš„å¼•å°æç¤º
gibbs_prompts = {
    "æè¿°": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œæè¿°ã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

ç³»çµ±åˆ†æç™¼ç¾ä»¥ä¸‹å¯èƒ½éºæ¼çš„éƒ¨åˆ†ï¼š
{missing_questions}

è«‹æ ¹æ“šé€™äº›è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œé¼“å‹µå­¸ç”Ÿæè¿°æ•´å€‹æƒ…å¢ƒï¼Œä¸¦æé†’ä»–å€‘å¯èƒ½éºæ¼çš„éƒ¨åˆ†ã€‚èªæ°£æ‡‰è©²æ˜¯é¼“å‹µæ€§çš„ï¼Œè€Œéæ‰¹è©•ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚""",

    "æ„Ÿå—": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œæ„Ÿå—ã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

å­¸ç”Ÿåœ¨ã€Œæè¿°ã€éšæ®µçš„å›ç­”æ˜¯ï¼š
{student_response}

è«‹ç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œé¼“å‹µå­¸ç”Ÿåˆ†äº«åœ¨é€™å€‹éç¨‹ä¸­çš„æƒ…ç·’å’Œæ„Ÿå—ï¼ŒåŒ…æ‹¬ç·Šå¼µã€å®‰å¿ƒã€å›°æƒ‘æˆ–æ‡Šæƒ±ç­‰ã€‚èªæ°£æ‡‰è©²æ˜¯æº«æš–ä¸”æ”¯æŒæ€§çš„ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚""",

    "è©•åƒ¹": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œè©•åƒ¹ã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

å­¸ç”Ÿåœ¨ã€Œæ„Ÿå—ã€éšæ®µçš„å›ç­”æ˜¯ï¼š
{student_response}

ç³»çµ±è©•åˆ†ï¼š{overall_score}/100

è«‹ç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œé¼“å‹µå­¸ç”Ÿè©•åƒ¹è‡ªå·±çš„è¡¨ç¾ï¼Œæ€è€ƒå“ªäº›éƒ¨åˆ†åšå¾—å¥½ã€å“ªäº›éƒ¨åˆ†å¯ä»¥æ”¹é€²ã€‚è«‹å¼•å°ä»–å€‘é€²è¡Œè‡ªè©•ï¼Œè€Œéç›´æ¥çµ¦äºˆè©•åƒ¹ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚""",

    "åˆ†æ": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œåˆ†æã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

å­¸ç”Ÿåœ¨ã€Œè©•åƒ¹ã€éšæ®µçš„å›ç­”æ˜¯ï¼š
{student_response}

ç³»çµ±åˆ†æç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š
- å›æ‡‰å»¶é²ï¼š{response_delays}
- æœªå‘½ä¸­é—œéµè©ï¼š{missed_keywords}

è«‹ç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œå¹«åŠ©å­¸ç”Ÿåˆ†æå•é¡Œç™¼ç”Ÿçš„åŸå› ï¼Œç†è§£ç‚ºä»€éº¼æœƒæœ‰é€™äº›è¡¨ç¾ã€‚å¼•å°æ‡‰è©²æ˜¯æ€è€ƒæ€§çš„ï¼Œå¹«åŠ©å­¸ç”Ÿæ·±å…¥æ¢ç´¢æ ¹æœ¬åŸå› ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚""",

    "çµè«–": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œçµè«–ã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

å­¸ç”Ÿåœ¨ã€Œåˆ†æã€éšæ®µçš„å›ç­”æ˜¯ï¼š
{student_response}

è«‹ç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œé¼“å‹µå­¸ç”Ÿå¾é€™æ¬¡ç¶“é©—ä¸­ç¸½çµå­¸åˆ°çš„å…§å®¹ï¼Œæç…‰å‡ºå€‹äººæˆé•·é»ã€‚å¼•å°æ‡‰è©²æ˜¯æ­£å‘ä¸”é¼“å‹µæ€§çš„ï¼Œå¹«åŠ©å­¸ç”Ÿçœ‹åˆ°è‡ªå·±çš„é€²æ­¥ç©ºé–“ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚""",

    "è¡Œå‹•è¨ˆç•«": """ä½ æ˜¯ä¸€ä½è­·ç†æ•™è‚²åæ€æ•™ç·´ï¼Œæ­£åœ¨å¼•å°å­¸ç”Ÿé€²è¡Œ Gibbs åæ€æ¨¡å‹çš„ã€Œè¡Œå‹•è¨ˆç•«ã€éšæ®µã€‚

å­¸ç”Ÿå‰›å®Œæˆä¸€æ®µæ¨¡æ“¬è­·ç†ç·´ç¿’ï¼Œä»¥ä¸‹æ˜¯å°è©±ç‰‡æ®µï¼š
{conversation}

å­¸ç”Ÿåœ¨ã€Œçµè«–ã€éšæ®µçš„å›ç­”æ˜¯ï¼š
{student_response}

è«‹ç”Ÿæˆä¸€æ®µå¼•å°èªï¼Œå”åŠ©å­¸ç”Ÿåˆ¶å®šå…·é«”çš„è¡Œå‹•è¨ˆç•«ï¼Œå°‡åæ€è½‰åŒ–ç‚ºå¯¦éš›æ”¹é€²æªæ–½ã€‚æä¾›ä¸€äº›å¯è¡Œçš„å»ºè­°ç¯„ä¾‹ï¼Œä½†é¼“å‹µå­¸ç”Ÿè‡ªå·±åˆ¶å®šæœ€çµ‚è¨ˆç•«ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€‚"""
}

def get_guidance(stage, student_response=None):
    """ç²å–ç‰¹å®š Gibbs éšæ®µçš„å¼•å°"""
    # æ§‹å»ºè«‹æ±‚é«”
    prompt = gibbs_prompts[stage]
    
    # æº–å‚™æ ¼å¼åŒ–åƒæ•¸
    format_params = {
        "conversation": sample_conversation,
        "student_response": student_response or "æˆ‘ä¸ç¢ºå®šè©²å¦‚ä½•å›ç­”é€™å€‹å•é¡Œã€‚",
        "missing_questions": "\n".join([f"ğŸ‘‰ {q}" for q in conversation_analysis["missing_questions"]]),
        "response_delays": "\n".join([f"- ç•¶ç—…äººæåˆ° '{d['after_statement']}' å¾Œï¼Œä½ åœé “äº† {d['delay_seconds']} ç§’" for d in conversation_analysis["response_delays"]]),
        "missed_keywords": ", ".join(conversation_analysis["missed_keywords"]),
        "overall_score": conversation_analysis["overall_score"]
    }
    
    # æ ¼å¼åŒ–æç¤º
    formatted_prompt = prompt.format(**format_params)
    
    data = {
        "model": "llama3-70b-8192",  # ä½¿ç”¨Llama 3æ¨¡å‹
        "messages": [
            {
                "role": "system",
                "content": formatted_prompt
            }
        ],
        "temperature": 0.7,
        "max_tokens": 1000
    }
    
    # ç™¼é€è«‹æ±‚
    response = requests.post(url, headers=headers, json=data)
    
    # æª¢æŸ¥éŸ¿æ‡‰
    if response.status_code == 200:
        result = response.json()
        answer = result["choices"][0]["message"]["content"]
        return answer
    else:
        return f"éŒ¯èª¤: {response.status_code}, {response.text}"

# å‰µå»ºè¼¸å‡ºç›®éŒ„
os.makedirs("src/lib/groq_test_results", exist_ok=True)

def interactive_reflection_dialogue():
    """äº’å‹•å¼åæ€å°è©±æµç¨‹"""
    dialogue = []
    student_responses = {}
    
    gibbs_stages = ["æè¿°", "æ„Ÿå—", "è©•åƒ¹", "åˆ†æ", "çµè«–", "è¡Œå‹•è¨ˆç•«"]
    
    print("\n===== æ­¡è¿ä½¿ç”¨ Gibbs åæ€æ¨¡å‹å¼•å°ç³»çµ± =====\n")
    print("ä»¥ä¸‹æ˜¯æ¨¡æ“¬çš„è­·ç†å°è©±ç‰‡æ®µï¼š")
    print(sample_conversation)
    print("\nç¾åœ¨å°‡é–‹å§‹å¼•å°æ‚¨å®Œæˆ Gibbs å…­éšæ®µåæ€æ¨¡å‹ã€‚\n")
    
    for i, stage in enumerate(gibbs_stages):
        print(f"\n===== ç¬¬ {i+1} éšæ®µï¼š{stage} =====\n")
        
        # å¦‚æœä¸æ˜¯ç¬¬ä¸€å€‹éšæ®µï¼Œä½¿ç”¨å‰ä¸€å€‹éšæ®µçš„å­¸ç”Ÿå›ç­”
        prev_stage = gibbs_stages[i-1] if i > 0 else None
        prev_response = student_responses.get(prev_stage) if prev_stage else None
        
        # ç²å–å¼•å°
        guidance = get_guidance(stage, prev_response)
        print(guidance)
        dialogue.append({"role": "assistant", "content": guidance, "stage": stage})
        
        # ç²å–å­¸ç”Ÿè¼¸å…¥
        print("\nè«‹è¼¸å…¥æ‚¨çš„åæ€å›ç­” (è¼¸å…¥å®Œæˆå¾ŒæŒ‰Enterï¼Œè¼¸å…¥'q'çµæŸ)ï¼š")
        lines = []
        while True:
            line = input()
            if line.lower() == 'q':
                break
            lines.append(line)
        
        student_response = "\n".join(lines)
        student_responses[stage] = student_response
        dialogue.append({"role": "user", "content": student_response, "stage": stage})
        
        print("\næ„Ÿè¬æ‚¨çš„å›ç­”ï¼æ­£åœ¨é€²å…¥ä¸‹ä¸€éšæ®µ...\n")
    
    # æ·»åŠ æœ€çµ‚ç¸½çµ
    final_summary = """æ„Ÿè¬ä½ å®Œæˆäº†é€™æ¬¡å®Œæ•´çš„ Gibbs åæ€å¾ªç’°ï¼

ä½ å·²ç¶“æˆåŠŸåœ°ï¼š
âœ… æè¿°äº†è‡¨åºŠæƒ…å¢ƒ
âœ… æ¢ç´¢äº†ä½ çš„æ„Ÿå—
âœ… è©•åƒ¹äº†è‡ªå·±çš„è¡¨ç¾
âœ… åˆ†æäº†å•é¡Œæ ¹æº
âœ… å¾—å‡ºäº†æœ‰åƒ¹å€¼çš„çµè«–
âœ… åˆ¶å®šäº†å…·é«”çš„è¡Œå‹•è¨ˆç•«

é€™ç¨®åæ€èƒ½åŠ›å°‡å¹«åŠ©ä½ åœ¨è­·ç†å¯¦è¸ä¸­ä¸æ–·æˆé•·ã€‚ä½ çš„è¡Œå‹•è¨ˆç•«éå¸¸å…·é«”ä¸”å¯è¡Œï¼Œå¸Œæœ›ä½ èƒ½å¤ å …æŒåŸ·è¡Œï¼Œä¸¦åœ¨ä¸‹æ¬¡æ¨¡æ“¬ä¸­çœ‹åˆ°é€²æ­¥ï¼

ä½ æœ‰ä»»ä½•å…¶ä»–å•é¡Œæˆ–éœ€è¦é€²ä¸€æ­¥çš„æ”¯æŒå—ï¼Ÿ"""
    
    print("\n===== åæ€å®Œæˆ =====\n")
    print(final_summary)
    dialogue.append({"role": "assistant", "content": final_summary, "stage": "ç¸½çµ"})
    
    # ä¿å­˜å®Œæ•´å°è©±
    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"src/lib/groq_test_results/reflection_dialogue_{timestamp}.json"
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(dialogue, f, ensure_ascii=False, indent=2)
    
    print(f"\næ‚¨çš„åæ€å°è©±å·²ä¿å­˜åˆ° {filename}")
    return dialogue

if __name__ == "__main__":
    import datetime
    interactive_reflection_dialogue() 